---
title: "Rmd File"
author: "Emily Daubenspeck"
date: "November 14, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Instructions


Attempt to implement at least 3 versions of your team's highest priority method as outlined in the revised proposal. This could look like:

If you are focusing on regression, you could:
Run a few bivariate regression models
Try a few subset selection methods
Experiment with ridge regression and lasso

If you are prioritizing classification, you could try kNN, QDA, LDA, and Logistic regression (and comparing the assumptions violated in each)
If your plan was to do classification and then regression, could the class on November 12 provide inspiration?
Leverage cross-validation with different number of folds to tune various hyper-parameters (such as penalties or the k in kNN).

```{r, message = FALSE, warning = FALSE}
## reading in data files, joining to access prescribing behavior (response vars)
library(tidyverse)
library(corrplot)
County_Drug <- read_csv("County_Drug.csv")
prescribing_behavior <- read_csv("293 COUNTY DATA/prescribing_behavior.csv") %>%
  mutate(county_id = paste0("05000US", FIPS)) %>%
  subset(select = -c(`State Name`, `State Abbreviation`, `County Name`, `FIPS`))
colnames(prescribing_behavior) <- c("part_d_prescribers", "part_d_opioid_prescribers", "opioid_claims", "extended_release_opioid_claims", "overall_claims", "opioid_prescribing_rate", "extended_release_prescription_rate", "change_in_rate", "county_id")

## joining data sets
working_data <- County_Drug %>%
  inner_join(prescribing_behavior, by = "county_id") %>%
  na.omit() %>%
  subset(select = -c(X1))

```

```{r, messaage = FALSE, warning = FALSE}

## some visualizations

ggplot(working_data, aes(x = opioid_prescribing_rate)) + 
  geom_histogram()

ggplot(working_data, aes(x = prescriber_immunity_criminal, fill = state_legislature)) + 
  geom_bar()

ggplot(working_data, aes(x = num_exchange, y = opioid_prescribing_rate)) + 
  geom_point()

numeric_only <- working_data[, sapply(working_data, is.numeric)] %>%
  select(unemployment_rate, hs_graduation_rate, male_proportion, female_proportion, num_exchange, poverty_rate, opioid_prescribing_rate, change_in_rate)
cor_data <- cor(numeric_only) %>%
  round(2)
corrplot(cor_data, method = "circle")

ggplot(working_data, aes(x = change_in_rate, y = opioid_prescribing_rate)) + 
  geom_point()
```

## Plot 1: Checking normality of response variable (opioid prescription rate)
The first graph in this series of initial visualizations is meant to help determine if the values of our response variable are distributed normally among the many counties (n > 2,000) that we will be using for analysis. We observe from this graph that the values are centered between 5% and 6%, and that they do not show any notable skew towards higher or lower values. If we decide to pursue regression, this is a huge positive.

## Plot 2: Examining makeup of state legislatures versus state harm reduction policies
We wanted to get a look at whether our initial intuition--that democrat-leaning states would represent a greater proportion of the states with comprehensive harm reduction policies--holds up within this data set. Actually, we note that in general, republican-leaning counties make up a larger proportion of our sample, and while they do make up the largest proportion of states without comprehensive HR policies, they also make up the largest proportion of states that do have these measures in place. This leads us to consider the results we might observe in our future analysis, which is based around the intution that more conservative states/counties will be less progressive in their harm reduction policy and have higher opioid prescription rates.

## Plot 3: Comparing harm reduction policy with opioid-prescription rate (state-level)
With this plot, we wanted to get a sense of whether basic harm reduction initatives, like needle exchanges, showed any obvious relationship with opioid prescribing rate (the intuition being that states implementing HR policies may also be taking steps to curb their opioid prescribing rate). We actually saw that there is a slight positive association between the number of needle exchanges and the prescribing rate, which in a way also makes a certain amount of sense. However, this association is relatively weak.

## Plot 4: Correlation of variables of interest (numeric)
As we are limited to calculating a correlation matrix for numeric variables, this is what we decided to do. We omitted variables associated with race because they would have made the table too large, and this is only a preliminary look. We observed that high correlation (0.5 < |cor|) is only really occurring where it is to be expected, between the proportions of male and female residents, as well as between the poverty rate and the unemployment rate. We might consider evaluating this second set of variables for relevance; perhaps one should be removed to lessen the potential for multicolinearity to interfere with model fitting.

## Plot 5: Scatterplot of opioid prescription rate versus change in that rate (since 2013)
This final scatterplot was created in order to investigate the relationship between prescription rate and the change in this rate since 2013. We wanted to evaluate whether high prescribing rates were coupled with significant decreases or increases in those rates over the temporal span between 2013 and 2015; we observed that the changes in rates are primarily clustered in the range [-5, 5] and that these changes guide prescription rates to within [1, 10], primarily. There is a single highly unusual county indicated as having both a prescribing rate and change in rate of 31.76; after looking specifically at this county, we have determined that perhaps prescription rate data was not available for this area in 2013, and so the "change in rate" simply jumped when data were eventually added. We will consider whether to include this case if change in prescription rate becomes a variable we'd like to explore further.

```{r, message = FALSE, warning = FALSE}
## numerical summaries
library(mosaic)
library(Hmisc)

favstats(working_data$population)

describe(working_data$opioid_prescribing_rate)

working_data %>%
  group_by(state_legislature) %>%
  summarise(mean = mean(opioid_prescribing_rate))

working_data %>%
  group_by(state) %>%
  summarise(avg_rate = mean(opioid_prescribing_rate)) %>%
  arrange(avg_rate) %>%
  tail(5)

working_data %>%
  group_by(state) %>%
  summarise(avg_rate = mean(opioid_prescribing_rate)) %>%
  arrange(avg_rate) %>%
  head(5)

```

## Summary 1: Quartile distribution of county population sizes
We thought it might be pertinent to our investigation to have some sense of the range of population sizes represented in our sample. We see that the median size is 33573 while the mean is 120263, indicating that this distribution is likely skewed towards higher populations.

## Summary 2: Highest and lowest opioid prescription rates
In order to get a better sense of what "normal" versus "extreme" might look like in the sense of opioid prescription rate, we took a look at the five lowest and five highest prescription rates. We wanted to see, first and foremost, if the highest rates were clustered closely together, or if there were some notable standouts. We were also interested in determining what these values tend to look like. We were able to observe that all but the highest prescribing rate fall below 19% (the highest is >30%). We were also able to determine that the lowest values do not share similar variation.

## Summary 3: Mean opioid prescription rate by state legislature composition
We wanted to determine whether there might be a significant association between political party and prescribing rates. After running these numbers, we observed that Republican and Democratic legislatures have nearly identical mean rates of prescription, and split legislatures are only slightly lower. Nebraska is a unicameral legislature and has an even lower mean, though we are chalking this up to it's status as the singular unicameral legislative body in the nation.

## Summary 4: Highest prescribing states
As we began to wind down our preliminary visualizations, we decided to determine which 5 states had the highest average (mean) prescribing rates and which had the lowest. The highest states included Nevada, Washington, Utah, Colorado, and Oregon, while the lowest were Rhode Island, New York, North Dakota, Massachusetts, and New Jersey (both lists in descending order). This summary has helped us to better observe the presence of a regional divide in prescribing practices (east vs. west), and it presents some interesting ideas as we think about ways in which we may want to expand on our data (i.e. categorizing states by region to perform more aggregate analyses).

```{r}
## first attempt at methods

working_data$over_avg_rx_rate = 0
working_data$over_avg_rx_rate[working_data$opioid_prescribing_rate >median(working_data$opioid_prescribing_rate)] = 1

glm_fit = glm(over_avg_rx_rate ~ unemployment_rate +
                    hs_graduation_rate,
                  data=working_data,
                  family = binomial)
summary(glm_fit)
```

## Method 1: Logistic Regression
For this first attempt, we considered unemployment rate and high school graduation rate as predictors of opioid prescribing rate (above or below average, when looking at the country as a whole). These two predictors were chosen due to their slight indicated correlation with opiod prescribing rate in Plot 4. The smallest p-value here is for high school graduation rate, and the negative coefficient suggests that as high school gradation rate in a county rises, the rate of opiod prescription is less likely to be greater than average. The p-values for both predictors here are very small, less than 0.01, so there's evidence that there is an association between them and prescribing rate. One concern for this step is it assumes the predictors are independant, and we actually found some correlation between high school graduation rate and unemployment rate.